<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Embeddings Service</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 3rem;
        }
        
        .header h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            background: white;
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border-left: 4px solid #667eea;
        }
        
        .card h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        
        .endpoints {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
        }
        
        .endpoint {
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }
        
        .method {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .get { background: #28a745; color: white; }
        .post { background: #007bff; color: white; }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-online { background: #28a745; }
        .status-loading { background: #ffc107; }
        
        .footer {
            text-align: center;
            color: white;
            opacity: 0.8;
            margin-top: 2rem;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .main-content {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Embeddings Service</h1>
            <p>REST + gRPC microservice for generating text embeddings using Sentence Transformers</p>
            <div style="margin-top: 1rem;">
                <span class="status-indicator status-loading" id="status"></span>
                <span id="status-text">Checking status...</span>
            </div>
        </div>
        
        <div class="main-content">
            <h2>üöÄ About This Service</h2>
            <p>
                This lightweight microservice generates high-quality text embeddings using state-of-the-art 
                Sentence Transformer models. It's designed for easy integration into ML pipelines, search systems, 
                and recommendation engines.
            </p>
            
            <div class="grid">
                <div class="card">
                    <h3>üéØ Features</h3>
                    <ul>
                        <li>High-quality text embeddings</li>
                        <li>Batch processing support</li>
                        <li>REST and gRPC interfaces</li>
                        <li>Configurable models and devices</li>
                        <li>Production-ready architecture</li>
                    </ul>
                </div>
                
                <div class="card">
                    <h3>üîß Tech Stack</h3>
                    <ul>
                        <li>Python 3.8+</li>
                        <li>FastAPI for REST API</li>
                        <li>gRPC for high-performance calls</li>
                        <li>Sentence Transformers</li>
                        <li>PyTorch backend</li>
                    </ul>
                </div>
                
                <div class="card">
                    <h3>üìä Current Model</h3>
                    <ul>
                        <li><strong>Model:</strong> <code id="model-id">Loading...</code></li>
                        <li><strong>Device:</strong> <code id="device">Loading...</code></li>
                        <li><strong>Dimensions:</strong> <code id="dimensions">Loading...</code></li>
                        <li><strong>Batch Size:</strong> <code id="batch-size">Loading...</code></li>
                    </ul>
                </div>
            </div>
            
            <h2>üåê API Endpoints</h2>
            <div class="endpoints">
                <div class="endpoint">
                    <span class="method get">GET</span>
                    <strong>/</strong> - This documentation page
                </div>
                <div class="endpoint">
                    <span class="method get">GET</span>
                    <strong>/health</strong> - Service health check and model information
                </div>
                <div class="endpoint">
                    <span class="method post">POST</span>
                    <strong>/embed</strong> - Generate embeddings for text(s)
                </div>
                <div class="endpoint">
                    <span class="method post">POST</span>
                    <strong>/embed/chunked</strong> - Generate embeddings for long text with auto-chunking
                </div>
                <div class="endpoint">
                    <span class="method get">GET</span>
                    <strong>/docs</strong> - Interactive API documentation (Swagger UI)
                </div>
            </div>
            
            <h2>üí° Usage Examples</h2>
            
            <div class="card" style="margin-bottom: 1.5rem; background: #fff3cd; border-left: 4px solid #856404;">
                <h3 style="color: #856404;">üîê Authentication Required</h3>
                <p>The <code>/embed</code> endpoint requires authentication using Bearer tokens (API keys). Contact your administrator for API keys.</p>
                <p><strong>Available accounts:</strong> admin, user1, app1, monitoring</p>
            </div>
            
            <h3>Single Text Embedding (Authenticated)</h3>
            <div class="code-block">
curl -X POST "%base_url%/embed" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer sk-admin-abc123xyz789" \
  -d '{
    "text": "Artificial intelligence is transforming the world",
    "task_type": "passage",
    "normalize": true,
    "chunking": true,
    "chunk_size": 1000,
    "chunk_overlap": 100
  }'
            </div>
            
            <h3>Single Text Without Chunking (Authenticated)</h3>
            <div class="code-block">
curl -X POST "%base_url%/embed" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer sk-admin-abc123xyz789" \
  -d '{
    "text": "Short text without chunking",
    "task_type": "passage",
    "normalize": true,
    "chunking": false
  }'
            </div>
            
            <h3>Batch Text Embeddings (Authenticated)</h3>
            <div class="code-block">
curl -X POST "%base_url%/embed" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer sk-user1-def456uvw012" \
  -d '{
    "texts": [
      "Machine learning enables intelligent systems",
      "Deep learning powers modern AI applications"
    ],
    "task_type": "passage",
    "normalize": true
  }'
            </div>
            
            <h3>Health Check (Public)</h3>
            <div class="code-block">
curl -X GET "%base_url%/health"
            </div>
            
            <h3>Long Text with Auto-Chunking (Authenticated)</h3>
            <div class="code-block">
curl -X POST "%base_url%/embed/chunked" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer sk-admin-abc123xyz789" \
  -d '{
    "text": "Very long text that needs chunking...",
    "chunk_size": 1000,
    "chunk_overlap": 100,
    "task_type": "passage",
    "normalize": true
  }'
            </div>
            
            <h3>Example Response with Chunking (Default)</h3>
            <div class="code-block">
{
  "model_id": "BAAI/bge-m3",
  "dim": 1024,
  "embedding": [0.1234, -0.5678, ...],
  "chunk_count": 3,
  "aggregation": "mean",
  "chunks": [
    {
      "index": 0,
      "text_preview": "First chunk text...",
      "length": 1000,
      "embedding": [...]
    }
  ],
  "requested_by": "admin"
}
            </div>
            
            <h3>Example Response Without Chunking</h3>
            <div class="code-block">
{
  "model_id": "BAAI/bge-m3",
  "dim": 1024,
  "embedding": [0.1234, -0.5678, ...],
  "requested_by": "admin"
}
            </div>
        </div>
        
        <div class="footer">
            <p>
                üîó <a href="/docs" style="color: white;">Interactive API Docs</a> | 
                üìã <a href="/health" style="color: white;">Health Check</a> |
                üß† Powered by Sentence Transformers
            </p>
        </div>
    </div>
    
    <script>
        // Dynamic content loading with timeout and error handling
        const baseUrl = window.location.origin;
        
        // Update base URL in code examples
        document.querySelectorAll('.code-block').forEach(block => {
            let search = '%base_url%';
            while (block.innerHTML.includes(search)) {
                block.innerHTML = block.innerHTML.replace(search, baseUrl);
            }
        });
        
        // Check service health and update status with timeout
        const checkHealth = async () => {
            const statusIndicator = document.getElementById('status');
            const statusText = document.getElementById('status-text');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                
                const response = await fetch('/health', { 
                    signal: controller.signal 
                });
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                statusIndicator.className = 'status-indicator status-online';
                statusText.textContent = 'Online';
                
                // Update model information
                document.getElementById('model-id').textContent = data.model_id || 'N/A';
                document.getElementById('device').textContent = data.device || 'N/A';
                document.getElementById('dimensions').textContent = data.dim || 'N/A';
                document.getElementById('batch-size').textContent = data.batch_size || 'N/A';
            } catch (error) {
                console.error('Error fetching health data:', error);
                
                statusIndicator.className = 'status-indicator';
                statusIndicator.style.background = '#dc3545';
                
                if (error.name === 'AbortError') {
                    statusText.textContent = 'Timeout';
                } else {
                    statusText.textContent = 'Offline';
                }
                
                // Set default values for model info
                document.getElementById('model-id').textContent = 'N/A';
                document.getElementById('device').textContent = 'N/A';
                document.getElementById('dimensions').textContent = 'N/A';
                document.getElementById('batch-size').textContent = 'N/A';
            }
        };
        
        // Run health check on page load
        checkHealth();
    </script>
</body>
</html>